import openai
import urllib.parse
import re
import time

# main function to perform attack
def main_function(url, payloads, check):
    opener = urllib.request.urlopen(url)
    output = {"payload":[], "code_snippet":[], "bug":[], "total_bugs":0}
    if opener.code == 999:
        time.sleep(3)
    for params in url.split("?")[1].split("&"):
        for payload in payloads:
            bugs = url.replace(params, params + str(payload).strip())
            bugs = bugs.replace(" ","")
            request = urllib.request.urlopen(bugs)
            html = request.readlines()
            for line in html:
                checker = re.findall(check, line.decode('utf-8'))
                if len(checker) != 0:
                    output["total_bugs"] += 1
                    output["payload"].append(payload)
                    output["code_snippet"].append(line.strip().decode())
                    output["bug"].append(bugs)
    if output["total_bugs"] == 0:
        return  1
    else:
        return output