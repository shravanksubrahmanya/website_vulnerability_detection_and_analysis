{% extends 'base.html' %}
{% load bootstrap4 %}
{% load static %}

{% block content %}
<div class="centerstage container"> 
    <h1 class="techfont">Scan Details</h1>
        <div class="describe_font"> 
            <div class="container">
            </div>
            <table class="table table-bordered datatable table-striped table-hover table-active">
                <thead> 
                    <tr>
                        <td width="40%" rowspan="2" colspan="2"><canvas id="myPieChart" style="width:200px;"></canvas></td>
                        <td width="30%" colspan="2">
                            <label class="headline" style="font-family: 'Russo One',sans-serif;">Total Queries</label> <br>
                            <label class="answer">{{total_queries}}</label>
                        </td>
                        <td width="30%" colspan="2">
                            <label class="headline" style="font-family: 'Russo One',sans-serif;">Total Vulnerabilities</label></br>
                            <label class="answer" style="color:red;">{{total_vulnerabilities}}</label>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <label class="headline" style="font-family: 'Russo One',sans-serif;"> Percentage </label></br>
                            <label id="aggre" class="answer"> </label>
                        </td>
                    </tr>
                    <tr>
                        <th>Sl. No.</th>
                        <th>Target</th>
                        <th>Scan Type</th>
                        <th>Last Scan </th>
                        <th>Vulnerable to</th>
                        <th>Status</th>
                        <th>View Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for scan_detail in scandetail_list %}
                    <tr>
                        <td> {{ scan_detail.url }} </td>
                        <td> {{ scan_detail.scan_type }} </td>
                        <td> {{ scan_detail.scan_time|date:"F j, Y H:i:s" }} </td>
                        <td> 
                            {% if scan_detail.vuln_cats is not None %}
                                <ul class="list-inline">
                                    {% for index in scan_detail.vuln_cats %}
                                    {% if index == '1' %}
                                        <li class="list-inline-item">SQL Injection</li>
                                    {% elif index == '2'%}
                                        <li class="list-inline-item">Cross Site Scripting</li>
                                    {% elif index == '3'%}
                                        <li class="list-inline-item">Remote Code Execution</li>
                                    {% endif %}
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p>No vulnerabilities<p>
                            {% endif %}
                            </td>
                        <td> 
                            {% if scan_detail.status == 1 %}
                                <span class="glyphicon glyphicon-ok text-success"> Secure </span>
                            {% else %}
                                <span class="glyphicon glyphicon-remove text-danger"> Vulnerable </span>
                            {% endif %}
                        </td>
                        {% if scan_detail.status == 1 %}
                        <td><a class="btn btn-primary disabled"><span class="glyphicon glyphicon-eye-open"> </span></a></td>
                        {% else %}
                        <td><a class="btn btn-primary" href="{% url 'scanner:scandetail_detail' pk=scan_detail.pk %}"><span class="glyphicon glyphicon-eye-open"> </span></a></td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    
        <script>
            // JavaScript code for generating the pie chart
            var ctx = document.getElementById('myPieChart').getContext('2d');

            document.getElementById('aggre').innerHTML = (({{total_vulnerabilities}} / {{total_queries}}) * 100).toFixed(2) + "%"

            var myPieChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: {{ pie_labels|safe }},
                datasets: [{
                data: {{ pie_data|safe }},
                backgroundColor: [
                    'rgb(255, 99, 132)',
                    'rgb(54, 162, 235)',
                    'rgb(255, 205, 86)'
                ],
                }]
            },
            options: {
                // Additional customization options for the chart
                 // Customize the chart options
                    responsive: true, // Make the chart responsive
                    maintainAspectRatio: false, // Disable aspect ratio scaling

                    // Set the width of the chart
                    width: 200, 

                    // Set the color options
                    elements: {
                        arc: {
                        backgroundColor: '#ff6384', // Replace with your desired color
                        borderColor: '#ffffff', // Replace with your desired color
                        borderWidth: 2 // Set the border width
                        }
                    }
            }
            });

        </script>
</div>
{% endblock content %}